<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Question Viewer</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Desmos Graphing Calculator API -->
    <script src="https://www.desmos.com/api/v1.6/calculator.js?apiKey={{ desmos_api_key|default('dcb31709b452b1cf9dc26972add0fda6') }}"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f8f9fa; }
        .meta { margin-bottom: 1em; }
        .question { font-size: 1.2em; margin-bottom: 1em; }
        .options { margin-bottom: 1em; }
        .option { margin: 0.5em 0; }
        .rationale { background: #eef; padding: 1em; border-radius: 8px; }
        .correct { color: green; font-weight: bold; }
        .practice-row {
            display: flex;
            gap: 2em;
            align-items: flex-start;
            margin-top: 2em;
        }
        .practice-left {
            flex: 2;
            min-width: 0;
        }
        .practice-right {
            flex: 1;
            min-width: 0;
            display: flex;
            justify-content: center;
            flex-direction: column;
        }
        .reveal-btn {
            margin-top: 1em;
            padding: 0.6em 1.5em;
            font-size: 1em;
            background: #3e7cb6;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(62,124,182,0.08);
            transition: background 0.2s;
        }
        .reveal-btn:hover {
            background: #2d3a4b;
        }
        .toggle-desmos {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            height: 32px;
            margin-bottom: 0.5em;
        }
        #arrow-icon {
            background: none;
            border: none;
            outline: none;
            padding: 0.1em 0.3em;
            display:inline-block;
            font-size:1.5em;
            color:#3e7cb6;
            cursor:pointer;
            user-select:none;
            transition:transform 0.3s;
        }
        #arrow-icon.hide {
            transform: rotate(-90deg);
            color: #bbb;
        }
        #arrow-icon.show {
            transform: rotate(0deg);
            color: #3e7cb6;
        }
        #desmos-container.hide {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95) translateY(20px);
        }
        #desmos-container.show {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1) translateY(0);
        }
        .debugger {
            margin-top: 2em;
            background: #ffe;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1em;
            font-size: 0.95em;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>SAT Question Viewer</h1>
    <!-- Removed broken JS assignment, handled in main script below -->
    {% if data %}
    <div class="meta">
        <strong>Assessment:</strong> SAT | 
        <strong>Test:</strong>  <span id="meta-test">{{ cat[0] }}</span> | 
        <strong>Domain:</strong> <span id="meta-domain">{{ cat[1] }}</span> | 
        <strong>Skill:</strong> <span id="meta-skill">{{ domain }}</span> | 
        <strong>Difficulty:</strong> <span id="meta-difficulty">{{ difficulty }}</span>
    </div>

    <div class="practice-row">
        <div class="practice-left">
            {% if data['stimulus'] %}
            <div class="stimulus" style="margin-bottom:1em; background:#f4f7fa; border-radius:8px; padding:1em; border:1px solid #e0eafc;">
                {{ data['stimulus']|safe }}
            </div>
            {% endif %}
            <div class="question">
                {{ data['stem']|safe }}
            </div>
            <div class="options">
                <strong>Answer Options:</strong>
                <ul>
                {% for opt in data['answerOptions'] %}
                    <li class="option">{{ opt['content']|safe }}</li>
                {% endfor %}
                </ul>
            </div>
            <button id="reveal-btn" class="reveal-btn">Reveal Answer &amp; Explanation</button>
            <div class="correct" id="answer-section" style="display:none;">
                Correct Answer: {{ data['correct_answer']|join(', ') }}
            </div>
            <div class="rationale" id="rationale-section" style="display:none;">
                <strong>Rationale:</strong><br>
                {{ data['rationale']|safe }}
            </div>
        </div>
        <div class="practice-right">
            <div id="toggle-desmos" class="toggle-desmos" title="Show/Hide Calculator">
                <span id="arrow-icon" style="display:inline-block; font-size:1.5em; color:#3e7cb6; cursor:pointer; user-select:none; transition:transform 0.3s;">&#8594;</span>
            </div>
            <div id="desmos-container" style="margin-top:1em;">
                <div id="desmos-calculator" style="width:400px; height:400px; border:1px solid #ccc; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition: opacity 0.4s, transform 0.4s;"></div>
            </div>
        </div>
    </div>
    <div style="text-align:center; margin-top:2em;">
        <button id="load-random-btn" class="reveal-btn" style="background:#2d3a4b;">Load Another Random Question</button>
    </div>
    <div class="debugger">
        <strong>Debugger (data variable):</strong>
        <pre style="white-space:pre-wrap; word-break:break-word;">{{ data | tojson(indent=2) }}</pre>
    </div>
    {% else %}
        <p>No question data found.</p>
    {% endif %}
</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // showDesmos is now set in a separate <script> block above
        function setupDesmos(show) {
            var elt = document.getElementById('desmos-calculator');
            var desmosContainer = document.getElementById('desmos-container');
            var toggleBtn = document.getElementById('toggle-desmos');
            var arrowIcon = document.getElementById('arrow-icon');
            if (show) {
                if (desmosContainer) desmosContainer.style.display = '';
                if (toggleBtn) toggleBtn.style.display = 'flex';
                if (elt && typeof Desmos !== 'undefined') {
                    if (!window.calculator) {
                        window.calculator = Desmos.GraphingCalculator(elt, {
                            expressions: true,
                            keypad: true,
                            settingsMenu: false,
                            zoomButtons: true,
                            lockViewport: false
                        });
                        window.calculator.setExpression({ id: 'graph1'});
                    }
                }
                if (toggleBtn && desmosContainer && arrowIcon) {
                    desmosContainer.classList.add('show');
                    arrowIcon.classList.add('show');
                    toggleBtn.onclick = function() {
                        if (desmosContainer.classList.contains('show')) {
                            desmosContainer.classList.remove('show');
                            desmosContainer.classList.add('hide');
                            arrowIcon.classList.remove('show');
                            arrowIcon.classList.add('hide');
                        } else {
                            desmosContainer.classList.remove('hide');
                            desmosContainer.classList.add('show');
                            arrowIcon.classList.remove('hide');
                            arrowIcon.classList.add('show');
                        }
                    };
                }
            } else {
                if (desmosContainer) desmosContainer.style.display = 'none';
                if (toggleBtn) toggleBtn.style.display = 'none';
            }
        }
        // Initial setup
        setupDesmos({% if cat[0]|lower != 'english' %}true{% else %}false{% endif %});
        var revealBtn = document.getElementById('reveal-btn');
        var answerSection = document.getElementById('answer-section');
        var rationaleSection = document.getElementById('rationale-section');
        if (revealBtn) {
            revealBtn.addEventListener('click', function() {
                answerSection.style.display = 'block';
                rationaleSection.style.display = 'block';
                revealBtn.style.display = 'none';
            });
        }
        function updateQuestion(data) {
            // Show/hide Desmos for new question
            var isMath = (data.cat && data.cat[0] && data.cat[0].toLowerCase() !== 'english');
            setupDesmos(isMath);
            // Update meta section
            document.getElementById('meta-test').textContent = data.cat ? data.cat[0] : '';
            document.getElementById('meta-domain').textContent = data.cat ? data.cat[1] : '';
            document.getElementById('meta-skill').textContent = data.domain || '';
            document.getElementById('meta-difficulty').textContent = data.difficulty || '';
            // Update stimulus
            var stimDiv = document.querySelector('.stimulus');
            if (!stimDiv) {
                // If .stimulus div doesn't exist, create and insert it above .question
                var questionDiv = document.querySelector('.question');
                stimDiv = document.createElement('div');
                stimDiv.className = 'stimulus';
                stimDiv.style.marginBottom = '1em';
                stimDiv.style.background = '#f4f7fa';
                stimDiv.style.borderRadius = '8px';
                stimDiv.style.padding = '1em';
                stimDiv.style.border = '1px solid #e0eafc';
                questionDiv.parentNode.insertBefore(stimDiv, questionDiv);
            }
            stimDiv.innerHTML = data.stimulus || '';
            stimDiv.style.display = data.stimulus ? '' : 'none';
            // Update question
            document.querySelector('.question').innerHTML = data.stem || '';
            // Update options
            var optionsList = document.querySelector('.options ul');
            optionsList.innerHTML = '';
            if (data.answerOptions) {
                data.answerOptions.forEach(function(opt) {
                    var li = document.createElement('li');
                    li.className = 'option';
                    li.innerHTML = opt.content;
                    optionsList.appendChild(li);
                });
            }
            // Hide answer/rationale
            document.getElementById('answer-section').style.display = 'none';
            document.getElementById('rationale-section').style.display = 'none';
            document.getElementById('reveal-btn').style.display = '';
            // Update answer
            document.getElementById('answer-section').innerHTML = 'Correct Answer: ' + (data.correct_answer ? data.correct_answer.join(', ') : '');
            // Update rationale
            document.getElementById('rationale-section').innerHTML = '<strong>Rationale:</strong><br>' + (data.rationale || '');
            // Update debugger
            document.querySelector('.debugger pre').textContent = JSON.stringify(data, null, 2);
        }
        document.getElementById('load-random-btn').addEventListener('click', function(e) {
            e.preventDefault();
            fetch('/api/random-question')
                .then(response => response.json())
                .then(data => {
                    updateQuestion(data);
                });
        });
    });
</script>
</body>
</html>
